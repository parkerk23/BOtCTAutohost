<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood on the Clocktower - Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .player-circle {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            word-wrap: break-word;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .player-circle:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        .player-circle.self {
            border: 3px solid #fbbf24;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
        }
        .player-circle.dead {
            opacity: 0.5;
            background-color: #ef4444 !important;
            border-color: #dc2626 !important;
        }
        .player-circle.selected {
            border: 4px solid #10b981 !important;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.6) !important;
        }
        .game-map {
            position: relative;
            width: 500px;
            height: 500px;
            margin: 0 auto;
        }
        .center-timer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
        }
        .role-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 10;
        }
        .action-prompt {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans flex flex-col min-h-screen items-center justify-center">
    <div class="container mx-auto p-8 max-w-lg">
        <!-- Join Game Section -->
        <div id="joinSection" class="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700 space-y-6">
            <h1 class="text-3xl font-bold text-center text-red-500">Join a Game</h1>
            
            <input type="text" id="playerNameInput" placeholder="Enter your name" maxlength="20" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:border-red-500 transition-colors">
            
            <input type="text" id="gameCodeInput" placeholder="Enter game code" maxlength="4" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:border-red-500 transition-colors">
            
            <button id="joinGameBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                Join Game
            </button>

            <div id="joinError" class="hidden bg-red-900 border border-red-700 text-red-200 p-3 rounded-lg text-center">
                <!-- Error messages will appear here -->
            </div>
        </div>

        <!-- Lobby Section -->
        <div id="lobbySection" class="hidden bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700 space-y-6">
            <h1 class="text-3xl font-bold text-center text-red-500">Game Lobby</h1>
            <p id="lobbyGameCode" class="text-center text-xl font-mono text-gray-400"></p>
            
            <div id="playerListContainer" class="space-y-4">
                <h2 class="text-2xl font-semibold text-gray-300">Players in Lobby:</h2>
                <ul id="playerList" class="bg-gray-700 p-4 rounded-lg space-y-2">
                    <!-- Player list will be populated here by JavaScript -->
                </ul>
            </div>
            
            <div id="waitingMessage" class="text-center text-gray-300">
                <p>Waiting for host to start the game...</p>
            </div>
        </div>
    </div>

    <!-- Game Section -->
    <div id="gameSection" class="hidden min-h-screen relative bg-gray-900 w-full">
        <!-- Role Info (Bottom Left) -->
        <div class="role-info">
            <div class="bg-gray-800 p-4 rounded-lg border border-gray-600 max-w-xs">
                <h3 class="text-lg font-bold text-yellow-400 mb-2">Your Role</h3>
                <div id="roleCard" class="space-y-2">
                    <h4 id="roleName" class="text-xl font-bold text-center text-yellow-400"></h4>
                    <p id="roleAbility" class="text-gray-200 text-sm"></p>
                </div>
            </div>
        </div>

        <!-- Action Prompt (Bottom Right) -->
        <div class="action-prompt">
            <div id="actionPromptCard" class="hidden bg-blue-800 p-4 rounded-lg border border-blue-600 max-w-xs">
                <h3 class="text-lg font-bold text-blue-300 mb-2">Night Action</h3>
                <div id="actionContent">
                    <p id="actionDescription" class="text-blue-100 text-sm mb-3"></p>
                    <div id="actionButtons" class="space-y-2">
                        <!-- Action buttons will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Title and Code -->
        <div class="text-center pt-8">
            <h1 class="text-4xl font-bold text-red-500 mb-2">Blood on the Clocktower</h1>
            <p class="text-gray-400 font-mono">Game Code: <span id="gameMapCode"></span></p>
            <div id="phaseInfo" class="mt-4 text-xl">
                <span id="currentPhase" class="text-blue-400">Night</span> 
                <span id="currentDay" class="text-gray-300">1</span>
            </div>
        </div>

        <!-- Player Circle Map -->
        <div class="flex items-center justify-center min-h-screen">
            <div class="game-map">
                <!-- Players will be positioned around this circle -->
                <div id="playersCircle"></div>
                
                <!-- Center Timer -->
                <div class="center-timer">
                    <div class="bg-gray-800 border-2 border-gray-600 rounded-full w-32 h-32 flex flex-col items-center justify-center">
                        <div id="phaseDisplay" class="text-lg font-bold text-blue-400 mb-1">Night</div>
                        <div id="timerDisplay" class="text-2xl font-bold text-white">00:00</div>
                        <div id="dayCounter" class="text-sm text-gray-400">Day 1</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Feedback -->
        <div id="actionFeedback" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-800 text-white px-6 py-3 rounded-lg border border-green-600">
            <p id="feedbackText">Action feedback will appear here</p>
        </div>

        <!-- Info Modal -->
        <div id="infoModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-gray-800 p-6 rounded-lg border border-gray-600 max-w-md mx-4">
                <h3 id="infoModalTitle" class="text-xl font-bold text-yellow-400 mb-4"></h3>
                <div id="infoModalContent" class="text-gray-200 text-sm">
                    <!-- Modal content will be populated here -->
                </div>
                <button id="closeInfoModal" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            
            // DOM elements
            const joinSection = document.getElementById('joinSection');
            const lobbySection = document.getElementById('lobbySection');
            const gameSection = document.getElementById('gameSection');
            const playerNameInput = document.getElementById('playerNameInput');
            const gameCodeInput = document.getElementById('gameCodeInput');
            const joinGameBtn = document.getElementById('joinGameBtn');
            const joinError = document.getElementById('joinError');
            const lobbyGameCode = document.getElementById('lobbyGameCode');
            const playerList = document.getElementById('playerList');
            const waitingMessage = document.getElementById('waitingMessage');
            const gameMapCode = document.getElementById('gameMapCode');
            const roleName = document.getElementById('roleName');
            const roleAbility = document.getElementById('roleAbility');
            const playersCircle = document.getElementById('playersCircle');
            const phaseDisplay = document.getElementById('phaseDisplay');
            const currentPhase = document.getElementById('currentPhase');
            const currentDay = document.getElementById('currentDay');
            const timerDisplay = document.getElementById('timerDisplay');
            const dayCounter = document.getElementById('dayCounter');
            const actionFeedback = document.getElementById('actionFeedback');
            const feedbackText = document.getElementById('feedbackText');
            const actionPromptCard = document.getElementById('actionPromptCard');
            const actionDescription = document.getElementById('actionDescription');
            const actionButtons = document.getElementById('actionButtons');
            const infoModal = document.getElementById('infoModal');
            const infoModalTitle = document.getElementById('infoModalTitle');
            const infoModalContent = document.getElementById('infoModalContent');
            const closeInfoModal = document.getElementById('closeInfoModal');

            let currentPlayers = [];
            let mySocketId = socket.id;
            let selectedPlayer = null;
            let myRole = null;
            let isNightPhase = false;
            let nightActionCompleted = false;

            // Get socket ID when connected
            socket.on('connect', () => {
                console.log('Connected to server as player.');
                mySocketId = socket.id;
            });

            // Utility functions
            function showFeedback(message, type = 'success') {
                feedbackText.textContent = message;
                actionFeedback.className = `fixed top-4 left-1/2 transform -translate-x-1/2 text-white px-6 py-3 rounded-lg border ${
                    type === 'error' ? 'bg-red-800 border-red-600' : 'bg-green-800 border-green-600'
                }`;
                actionFeedback.classList.remove('hidden');
                setTimeout(() => {
                    actionFeedback.classList.add('hidden');
                }, 3000);
            }

            function showError(message) {
                joinError.textContent = message;
                joinError.classList.remove('hidden');
                setTimeout(() => {
                    joinError.classList.add('hidden');
                }, 5000);
            }

            function showInfoModal(title, content) {
                infoModalTitle.textContent = title;
                infoModalContent.innerHTML = content;
                infoModal.classList.remove('hidden');
            }

            function hideActionPrompt() {
                actionPromptCard.classList.add('hidden');
            }

            function showActionPrompt(description, buttons) {
                actionDescription.textContent = description;
                actionButtons.innerHTML = '';
                
                buttons.forEach(button => {
                    const btn = document.createElement('button');
                    btn.textContent = button.text;
                    btn.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors';
                    btn.onclick = button.action;
                    actionButtons.appendChild(btn);
                });
                
                actionPromptCard.classList.remove('hidden');
            }

            // Position players in a circle
            function positionPlayersInCircle(players) {
                console.log('Player: positionPlayersInCircle called with:', players);
                
                if (!playersCircle) {
                    console.error('playersCircle element not found!');
                    return;
                }
                
                playersCircle.innerHTML = '';
                
                if (!players || players.length === 0) {
                    console.log('No players to position');
                    return;
                }
                
                const centerX = 250;
                const centerY = 250;
                const radius = 180;
                
                players.forEach((player, index) => {
                    console.log(`Player: Positioning player ${index}: ${player.playerName}`);
                    const angle = (index / players.length) * 2 * Math.PI - Math.PI / 2;
                    const x = centerX + radius * Math.cos(angle) - 40;
                    const y = centerY + radius * Math.sin(angle) - 40;
                    
                    const playerElement = document.createElement('div');
                    const isMe = player.socketId === mySocketId;
                    const isDead = player.isAlive === false;
                    
                    let className = 'player-circle text-white';
                    if (isMe) {
                        className += ' self bg-yellow-600 border-2 border-yellow-400';
                    } else {
                        className += ' bg-blue-600 border-2 border-blue-400';
                    }
                    if (isDead) {
                        className += ' dead';
                    }
                    
                    playerElement.className = className;
                    playerElement.style.left = `${x}px`;
                    playerElement.style.top = `${y}px`;
                    playerElement.textContent = player.playerName;
                    playerElement.setAttribute('data-player-id', player.socketId);
                    playerElement.setAttribute('data-player-name', player.playerName);
                    
                    // Add click handler for night actions
                    if (!isDead && player.socketId !== mySocketId && isNightPhase && !nightActionCompleted) {
                        playerElement.addEventListener('click', () => {
                            handlePlayerClick(player);
                        });
                    }
                    
                    playersCircle.appendChild(playerElement);
                });
            }

            // Handle player clicks during night phase
            function handlePlayerClick(player) {
                if (!isNightPhase || nightActionCompleted) return;
                
                // Clear previous selection
                document.querySelectorAll('.player-circle').forEach(el => {
                    el.classList.remove('selected');
                });
                
                selectedPlayer = player;
                
                // Highlight selected player
                const selectedElement = document.querySelector(`[data-player-id="${player.socketId}"]`);
                if (selectedElement) {
                    selectedElement.classList.add('selected');
                }

                if (!myRole) return;

                switch (myRole.name) {
                    case 'Monk':
                        socket.emit('monk-protected-player', player.socketId);
                        showFeedback(`You protected ${player.playerName}`);
                        nightActionCompleted = true;
                        hideActionPrompt();
                        break;
                    case 'Imp':
                        socket.emit('imp-kill-player', player.socketId);
                        showFeedback(`You chose to kill ${player.playerName}`);
                        nightActionCompleted = true;
                        hideActionPrompt();
                        break;
                    case 'Poisoner':
                        socket.emit('poisoner-poisoned-player', player.socketId);
                        showFeedback(`You poisoned ${player.playerName}`);
                        nightActionCompleted = true;
                        hideActionPrompt();
                        break;
                    case 'Butler':
                        socket.emit('butler-watch-player', player.socketId);
                        showFeedback(`You aligned with ${player.playerName}`);
                        nightActionCompleted = true;
                        hideActionPrompt();
                        break;
                    case 'Slayer':
                        if (!isNightPhase) { // Slayer acts during day
                            socket.emit('slayer-kill-player', player.socketId);
                            showFeedback(`You used your slayer shot on ${player.playerName}`);
                        }
                        break;
                }
            }

            // Socket event handlers
            socket.on('joinedGame', (data) => {
                if (data.success) {
                    joinSection.classList.add('hidden');
                    lobbySection.classList.remove('hidden');
                    lobbyGameCode.textContent = `Game Code: ${data.gameCode}`;
                } else {
                    showError(data.message || 'Failed to join game. Please try again.');
                    joinGameBtn.textContent = 'Join Game';
                    joinGameBtn.disabled = false;
                }
            });

            socket.on('playerListUpdate', (players) => {
                console.log('Player received player list update:', players);
                currentPlayers = players;
                
                // Update lobby player list
                playerList.innerHTML = '';
                if (players.length === 0) {
                    playerList.innerHTML = '<li class="text-gray-400">No players yet...</li>';
                } else {
                    players.forEach(player => {
                        const li = document.createElement('li');
                        li.textContent = player.playerName;
                        li.className = 'text-gray-200 p-2 border-b border-gray-600 last:border-0';
                        playerList.appendChild(li);
                    });
                }
                
                // Update game map if game has started
                if (gameSection && !gameSection.classList.contains('hidden')) {
                    positionPlayersInCircle(players);
                }
            });

            socket.on('gameStarted', (data) => {
                console.log('Player: Game has started!', data);
                
                const playersToPosition = data.players || currentPlayers;
                currentPlayers = playersToPosition;
                
                // Don't switch views yet - wait for role assignment
                gameMapCode.textContent = lobbyGameCode.textContent.split(': ')[1];
                
                if (playersToPosition && playersToPosition.length > 0) {
                    currentPlayers = playersToPosition;
                }
            });

            socket.on('roleAssigned', (role) => {
                myRole = role;
                console.log('Your role has been assigned:', role);
                
                // NOW switch to game view since we have our role
                lobbySection.classList.add('hidden');
                gameSection.classList.remove('hidden');
                
                // Set role information
                roleName.textContent = role.name;
                roleAbility.textContent = role.ability;
                
                // Position players in circle now that we're in game view
                if (currentPlayers && currentPlayers.length > 0) {
                    console.log('Player: Positioning players after role assignment');
                    positionPlayersInCircle(currentPlayers);
                } else {
                    console.log('Player: No players to position after role assignment');
                }
                
                showFeedback(`You are the ${role.name}!`);
            });

            socket.on('phaseChanged', (data) => {
                console.log('Phase changed to:', data);
                
                phaseDisplay.textContent = data.phase;
                currentPhase.textContent = data.phase;
                currentDay.textContent = data.dayCount;
                dayCounter.textContent = `Day ${data.dayCount}`;
                
                isNightPhase = data.phase === 'Night';
                nightActionCompleted = false;
                
                // Update phase styling
                if (data.phase === 'Night') {
                    phaseDisplay.className = 'text-lg font-bold text-blue-400 mb-1';
                    currentPhase.className = 'text-blue-400';
                } else {
                    phaseDisplay.className = 'text-lg font-bold text-orange-400 mb-1';
                    currentPhase.className = 'text-orange-400';
                }
                
                hideActionPrompt();
            });

            socket.on('nightPhaseStarted', () => {
                isNightPhase = true;
                nightActionCompleted = false;
                console.log("Night phase started. You may perform your action.");
            });

            // Role-specific night action prompts
            socket.on('monkChoosePlayer', (data) => {
                if (myRole.name === 'Monk') {
                    showActionPrompt('Choose a player to protect from the demon:', [{
                        text: 'Click on a player to protect them',
                        action: () => hideActionPrompt()
                    }]);
                }
            });

            socket.on('impChooseTarget', (data) => {
                if (myRole.name === 'Imp') {
                    showActionPrompt('Choose your target for tonight:', [{
                        text: 'Click on a player to kill them (or yourself)',
                        action: () => hideActionPrompt()
                    }]);
                }
            });

            socket.on('poisonerChooseTarget', (data) => {
                if (myRole.name === 'Poisoner') {
                    showActionPrompt('Choose a player to poison:', [{
                        text: 'Click on a player to poison them',
                        action: () => hideActionPrompt()
                    }]);
                }
            });

            socket.on('butlerChoosePlayer', (data) => {
                if (myRole.name === 'Butler') {
                    showActionPrompt('Choose a player to align with:', [{
                        text: 'Click on a player to align with them',
                        action: () => hideActionPrompt()
                    }]);
                }
            });

            socket.on('fortuneTellerChoosePlayers', (data) => {
                if (myRole.name === 'Fortune Teller') {
                    // This needs special handling for 2 players
                    showActionPrompt('Choose 2 players to investigate:', [{
                        text: 'Select first player, then second player',
                        action: () => hideActionPrompt()
                    }]);
                }
            });

            // Information role results
            socket.on('washerwomanInfo', (data) => {
                showInfoModal('Washerwoman Information', 
                    `One of these players is the <strong>${data.role}</strong>:<br>
                    • ${data.players[0]}<br>• ${data.players[1]}`);
            });

            socket.on('librarianInfo', (data) => {
                if (data.message) {
                    showInfoModal('Librarian Information', data.message);
                } else {
                    showInfoModal('Librarian Information', 
                        `One of these players is an <strong>Outsider</strong>:<br>
                        • ${data.players[0]}<br>• ${data.players[1]}`);
                }
            });

            socket.on('investigatorInfo', (data) => {
                if (data.message) {
                    showInfoModal('Investigator Information', data.message);
                } else {
                    showInfoModal('Investigator Information', 
                        `One of these players is a <strong>Minion</strong>:<br>
                        • ${data.players[0]}<br>• ${data.players[1]}`);
                }
            });

            socket.on('chefInfo', (data) => {
                showInfoModal('Chef Information', 
                    `There are <strong>${data.pairCount}</strong> pairs of adjacent evil players.`);
            });

            socket.on('empathInfo', (data) => {
                showInfoModal('Empath Information', 
                    `<strong>${data.evilCount}</strong> of your living neighbors are evil.<br>
                    Left neighbor: ${data.leftNeighbor}<br>
                    Right neighbor: ${data.rightNeighbor}`);
            });

            socket.on('fortuneTellerResult', (data) => {
                showInfoModal('Fortune Teller Result', 
                    `Does either <strong>${data.target1}</strong> or <strong>${data.target2}</strong> register as a demon?<br>
                    <strong>${data.result}</strong>`);
            });

            socket.on('undertakerInfo', (data) => {
                if (data.message) {
                    showInfoModal('Undertaker Information', data.message);
                } else {
                    showInfoModal('Undertaker Information', 
                        `<strong>${data.executedPlayer}</strong> was executed today.<br>
                        Their role was: <strong>${data.role}</strong>`);
                }
            });

            socket.on('actionConfirmed', (message) => {
                showFeedback(message);
            });

            socket.on('playerDied', (data) => {
                showFeedback(`${data.player.playerName} has died`, 'error');
                // Update visual representation
                const playerElement = document.querySelector(`[data-player-id="${data.player.socketId}"]`);
                if (playerElement) {
                    playerElement.classList.add('dead');
                }
            });

            socket.on('gameEnded', (data) => {
                showInfoModal('Game Over', `<strong>${data.winCondition}</strong>`);
            });

            // UI Event handlers
            joinGameBtn.addEventListener('click', () => {
                const playerName = playerNameInput.value.trim();
                const gameCode = gameCodeInput.value.trim();

                if (!playerName) {
                    showError('Please enter your name.');
                    return;
                }

                if (!gameCode || gameCode.length !== 4) {
                    showError('Please enter a valid 4-digit game code.');
                    return;
                }

                socket.emit('joinGame', { gameCode: gameCode, playerName: playerName });
                joinGameBtn.textContent = 'Joining...';
                joinGameBtn.disabled = true;
            });

            closeInfoModal.addEventListener('click', () => {
                infoModal.classList.add('hidden');
            });

            // Allow Enter key navigation
            playerNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    gameCodeInput.focus();
                }
            });

            gameCodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    joinGameBtn.click();
                }
            });

            gameCodeInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 4);
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server.');
                showError('Disconnected from server. Please refresh and try again.');
                joinGameBtn.textContent = 'Join Game';
                joinGameBtn.disabled = false;
            });
        });
    </script>
</body>
</html>