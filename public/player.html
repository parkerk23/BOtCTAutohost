<style>
        .player-circle {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            word-wrap: break-word;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .player-circle:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        .player-circle.self {
            border: 3px solid #fbbf24;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
        }
        .player-circle.dead {
            opacity: 0.5;
            background-color: #ef4444 !important;
        }
        .game-map {
            position: relative;
            width: 500px;
            height: 500px;
            margin: 0 auto;
        }
        .center-timer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
        }
        .role-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 10;
        }
    </style><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood on the Clocktower - Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white font-sans flex flex-col min-h-screen items-center justify-center">
    <div class="container mx-auto p-8 max-w-lg">
        <div id="joinSection" class="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700 space-y-6">
            <h1 class="text-3xl font-bold text-center text-red-500">Join a Game</h1>
            
            <input type="text" id="playerNameInput" placeholder="Enter your name" maxlength="20" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:border-red-500 transition-colors">
            
            <input type="text" id="gameCodeInput" placeholder="Enter game code" maxlength="4" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:border-red-500 transition-colors">
            
            <button id="joinGameBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                Join Game
            </button>

            <div id="joinError" class="hidden bg-red-900 border border-red-700 text-red-200 p-3 rounded-lg text-center">
                <!-- Error messages will appear here -->
            </div>
        </div>

        <div id="lobbySection" class="hidden bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700 space-y-6">
            <h1 class="text-3xl font-bold text-center text-red-500">Game Lobby</h1>
            <p id="lobbyGameCode" class="text-center text-xl font-mono text-gray-400"></p>
            
            <div id="playerListContainer" class="space-y-4">
                <h2 class="text-2xl font-semibold text-gray-300">Players in Lobby:</h2>
                <ul id="playerList" class="bg-gray-700 p-4 rounded-lg space-y-2">
                    <!-- Player list will be populated here by JavaScript -->
                </ul>
            </div>
            
            <div id="waitingMessage" class="text-center text-gray-300">
                <p>Waiting for host to start the game...</p>
            </div>
        </div>

        <div id="gameSection" class="hidden min-h-screen relative bg-gray-900">
            <!-- Role Info (Bottom Left) -->
            <div class="role-info">
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-600 max-w-xs">
                    <h3 class="text-lg font-bold text-yellow-400 mb-2">Your Role</h3>
                    <div id="roleCard" class="space-y-2">
                        <h4 id="roleName" class="text-xl font-bold text-center text-yellow-400"></h4>
                        <p id="roleAbility" class="text-gray-200 text-sm"></p>
                    </div>
                </div>
            </div>

            <!-- Game Title and Code -->
            <div class="text-center pt-8">
                <h1 class="text-4xl font-bold text-red-500 mb-2">Blood on the Clocktower</h1>
                <p class="text-gray-400 font-mono">Game Code: <span id="gameMapCode"></span></p>
            </div>

            <!-- Player Circle Map -->
            <div class="flex items-center justify-center min-h-screen">
                <div class="game-map">
                    <!-- Players will be positioned around this circle -->
                    <div id="playersCircle"></div>
                    
                    <!-- Center Timer -->
                    <div class="center-timer">
                        <div class="bg-gray-800 border-2 border-gray-600 rounded-full w-32 h-32 flex flex-col items-center justify-center">
                            <div id="phaseDisplay" class="text-lg font-bold text-yellow-400 mb-1">Night</div>
                            <div id="timerDisplay" class="text-2xl font-bold text-white">00:00</div>
                            <div id="dayCounter" class="text-sm text-gray-400">Day 1</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Feedback -->
            <div id="actionFeedback" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-blue-800 text-white px-6 py-3 rounded-lg border border-blue-600">
                <p id="feedbackText">Action feedback will appear here</p>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            const joinSection = document.getElementById('joinSection');
            const lobbySection = document.getElementById('lobbySection');
            const gameSection = document.getElementById('gameSection');
            const playerNameInput = document.getElementById('playerNameInput');
            const gameCodeInput = document.getElementById('gameCodeInput');
            const joinGameBtn = document.getElementById('joinGameBtn');
            const joinError = document.getElementById('joinError');
            const lobbyGameCode = document.getElementById('lobbyGameCode');
            const playerList = document.getElementById('playerList');
            const waitingMessage = document.getElementById('waitingMessage');
            const gameMapCode = document.getElementById('gameMapCode');
            const roleName = document.getElementById('roleName');
            const roleAbility = document.getElementById('roleAbility');
            const playersCircle = document.getElementById('playersCircle');
            const phaseDisplay = document.getElementById('phaseDisplay');
            const timerDisplay = document.getElementById('timerDisplay');
            const dayCounter = document.getElementById('dayCounter');
            const actionFeedback = document.getElementById('actionFeedback');
            const feedbackText = document.getElementById('feedbackText');

            let currentPlayers = [];
            let mySocketId = null;
            let selectedPlayer = null;

            // Get socket ID when connected
            socket.on('connect', () => {
                console.log('Connected to server as player.');
                mySocketId = socket.id;
            });

            // Position players in a circle
            function positionPlayersInCircle(players) {
                console.log('Player: positionPlayersInCircle called with:', players);
                
                if (!playersCircle) {
                    console.error('playersCircle element not found!');
                    return;
                }
                
                playersCircle.innerHTML = ''; // Clear existing players
                
                if (!players || players.length === 0) {
                    console.log('No players to position');
                    return;
                }
                
                const centerX = 250; // Center of the 500px container
                const centerY = 250;
                const radius = 180; // Distance from center
                
                players.forEach((player, index) => {
                    console.log(`Player: Positioning player ${index}: ${player.playerName}`);
                    const angle = (index / players.length) * 2 * Math.PI - Math.PI / 2; // Start from top
                    const x = centerX + radius * Math.cos(angle) - 40; // -40 to center the 80px wide circle
                    const y = centerY + radius * Math.sin(angle) - 40; // -40 to center the 80px tall circle
                    
                    const playerElement = document.createElement('div');
                    const isMe = player.socketId === mySocketId;
                    
                    playerElement.className = `player-circle ${isMe ? 'self bg-yellow-600 border-2 border-yellow-400' : 'bg-blue-600 border-2 border-blue-400'} text-white`;
                    playerElement.style.left = `${x}px`;
                    playerElement.style.top = `${y}px`;
                    playerElement.textContent = player.playerName;
                    playerElement.setAttribute('data-player-id', player.socketId);
                    playerElement.setAttribute('data-player-name', player.playerName);
                    
                    // Add click handler
                    playerElement.addEventListener('click', () => {
                        handlePlayerClick(player);
                    });
                    
                    console.log(`Player: ${player.playerName} positioned at (${x}, ${y})`);
                    playersCircle.appendChild(playerElement);
                });
                
                console.log(`Player: Total players positioned: ${players.length}`);
                console.log('Player: playersCircle element:', playersCircle);
                console.log('Player: playersCircle children:', playersCircle.children.length);
            }

            // Handle player clicks
            function handlePlayerClick(player) {
                if (player.socketId === mySocketId) {
                    showFeedback("You can't target yourself!");
                    return;
                }
                
                selectedPlayer = player;
                showFeedback(`Selected: ${player.playerName}`);
                
                // Highlight selected player
                document.querySelectorAll('.player-circle').forEach(el => {
                    el.classList.remove('ring-4', 'ring-green-400');
                });
                
                const selectedElement = document.querySelector(`[data-player-id="${player.socketId}"]`);
                if (selectedElement) {
                    selectedElement.classList.add('ring-4', 'ring-green-400');
                }
            }

            // Show feedback message
            function showFeedback(message) {
                feedbackText.textContent = message;
                actionFeedback.classList.remove('hidden');
                setTimeout(() => {
                    actionFeedback.classList.add('hidden');
                }, 3000);
            }

            // Show error message
            function showError(message) {
                joinError.textContent = message;
                joinError.classList.remove('hidden');
                setTimeout(() => {
                    joinError.classList.add('hidden');
                }, 5000);
            }

            // Reset join button
            function resetJoinButton() {
                joinGameBtn.textContent = 'Join Game';
                joinGameBtn.disabled = false;
            }

            // Handle join game button click
            joinGameBtn.addEventListener('click', () => {
                const playerName = playerNameInput.value.trim();
                const gameCode = gameCodeInput.value.trim();

                if (!playerName) {
                    showError('Please enter your name.');
                    return;
                }

                if (!gameCode || gameCode.length !== 4) {
                    showError('Please enter a valid 4-digit game code.');
                    return;
                }

                socket.emit('joinGame', { gameCode: gameCode, playerName: playerName });
                joinGameBtn.textContent = 'Joining...';
                joinGameBtn.disabled = true;
            });

            // Handle successful game join
            socket.on('joinedGame', (data) => {
                if (data.success) {
                    joinSection.classList.add('hidden');
                    lobbySection.classList.remove('hidden');
                    lobbyGameCode.textContent = `Game Code: ${data.gameCode}`;
                } else {
                    showError(data.message || 'Failed to join game. Please try again.');
                    resetJoinButton();
                }
            });

            // Update player list in lobby
            socket.on('playerListUpdate', (players) => {
                console.log('Player received player list update:', players);
                currentPlayers = players; // Store current players
                
                playerList.innerHTML = '';
                if (players.length === 0) {
                    playerList.innerHTML = '<li class="text-gray-400">No players yet...</li>';
                } else {
                    players.forEach(player => {
                        const li = document.createElement('li');
                        li.textContent = player.playerName;
                        li.className = 'text-gray-200 p-2 border-b border-gray-600 last:border-0';
                        playerList.appendChild(li);
                    });
                }
                
                // Update game map if game has started
                if (gameSection && !gameSection.classList.contains('hidden')) {
                    positionPlayersInCircle(players);
                }
            });

            // Handle game start
            socket.on('gameStarted', (data) => {
                console.log('Player: Game has started!', data);
                
                const playersToPosition = data.players || currentPlayers;
                console.log('Player: Players to position:', playersToPosition);
                
                // Switch to game view
                lobbySection.classList.add('hidden');
                gameSection.classList.remove('hidden');
                
                gameMapCode.textContent = lobbyGameCode.textContent.split(': ')[1];
                
                // Position players in circle
                if (playersToPosition && playersToPosition.length > 0) {
                    currentPlayers = playersToPosition;
                    console.log('Player: About to position players in circle');
                    positionPlayersInCircle(playersToPosition);
                } else {
                    console.log('Player: No players to position');
                }
            });

            // Handle game start
            socket.on('gameStarted', (data) => {
                console.log('Player: Game has started!', data);
                
                const playersToPosition = data.players || currentPlayers;
                console.log('Player: Players to position:', playersToPosition);
                
                // Update the waiting message but don't switch views yet - wait for role assignment
                waitingMessage.innerHTML = '<p class="text-center text-xl text-green-400 animate-pulse">Game started! Receiving your role...</p>';
                
                // Store the player data for when we transition to game view
                if (playersToPosition && playersToPosition.length > 0) {
                    currentPlayers = playersToPosition;
                }
            });
            
            
            socket.on('monk-ability', (playersAlive) => {
                // Logic to display a list of players for the Monk to choose from
                const selectElement = document.getElementById('monkProtectSelect');
                selectElement.innerHTML = ''; // Clear previous options
                
                playersAlive.forEach(player => {
                    if (player.role !== 'Monk') { // The Monk cannot protect themself
                        const option = document.createElement('option');
                        option.value = player.socketId;
                        option.textContent = player.playerName;
                        selectElement.appendChild(option);
                    }
                });

                // Show the selection interface to the Monk
                document.getElementById('monkAbilityDiv').style.display = 'block';

                document.getElementById('monkProtectButton').addEventListener('click', () => {
                    const protectedPlayerSocketId = selectElement.value;
                    // Send a message to the server with the chosen player
                    socket.emit('monk-protected-player', protectedPlayerSocketId);
                    // Hide the interface after selection
                    document.getElementById('monkAbilityDiv').style.display = 'none';
                });
            });
            
            // Handle role assignment
            socket.on('roleAssigned', (role) => {
                console.log('Your role has been assigned:', role);
                
                // NOW switch to game view since we have our role
                lobbySection.classList.add('hidden');
                gameSection.classList.remove('hidden');
                
                // Set the game code in the game view
                gameMapCode.textContent = lobbyGameCode.textContent.split(': ')[1];
                
                // Set role information
                roleName.textContent = role.name;
                roleAbility.textContent = role.ability;
                
                // Position players in circle
                if (currentPlayers && currentPlayers.length > 0) {
                    console.log('Player: Positioning players after role assignment');
                    positionPlayersInCircle(currentPlayers);
                } else {
                    console.log('Player: No players to position after role assignment');
                }
                
                showFeedback(`You are the ${role.name}!`);
            });

            // Handle connection events
            socket.on('connect', () => {
                console.log('Connected to server as player.');
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server.');
                showError('Disconnected from server. Please refresh and try again.');
                resetJoinButton();
            });

            // Allow Enter key to join game
            playerNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    gameCodeInput.focus();
                }
            });

            gameCodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    joinGameBtn.click();
                }
            });

            // Only allow numbers in game code input
            gameCodeInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 4);
            });
        });
    </script>
</body>
</html>